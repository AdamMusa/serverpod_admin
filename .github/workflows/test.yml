# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Serverpod Admin CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  dart_analyze_server:
    name: dart analyze (server)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.32.0', '3.38.4']
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Install dependencies
        working-directory: serverpod_admin_server
        run: dart pub get

      - name: Analyze server source
        working-directory: serverpod_admin_server
        run: dart analyze

  dart_analyze_dashboard:
    name: dart analyze (dashboard)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.32.0', '3.38.4']
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Install dependencies
        working-directory: serverpod_admin_dashboard
        run: flutter pub get

      - name: Analyze dashboard source
        working-directory: serverpod_admin_dashboard
        run: |
          # Run analyze and filter out expected warnings for monorepo
          OUTPUT=$(flutter analyze 2>&1) || true
          # Filter out expected warnings:
          # 1. Path dependency warning (expected in monorepo)
          # 2. DropdownButtonFormField value deprecation (initialValue not available in tested Flutter versions)
          FILTERED=$(echo "$OUTPUT" | grep -v "Publishable packages can't have 'path' dependencies" | grep -v "Use initialValue instead")
          echo "$FILTERED"
          # Count real issues (excluding expected warnings)
          REAL_ISSUES=$(echo "$FILTERED" | grep -cE "(error|warning|info) â€¢" || echo "0")
          if [ "$REAL_ISSUES" -gt "0" ]; then
            echo "Found $REAL_ISSUES analysis issue(s)"
            exit 1
          fi
          echo "Analysis passed (expected warnings ignored)"

  server_integration_tests:
    name: Server integration tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.32.0', '3.38.4']
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: serverpod_admin_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Install dependencies
        working-directory: serverpod_admin_server
        run: dart pub get

      - name: Update test configuration for CI
        working-directory: serverpod_admin_server
        run: |
          # Update test.yaml to use standard ports for GitHub Actions
          sed -i 's/port: 9090/port: 5432/' config/test.yaml
          sed -i 's/port: 9091/port: 6379/' config/test.yaml
          # Keep Redis disabled for CI since GitHub Actions Redis doesn't require password
          # but Serverpod tries to authenticate when enabled
          # sed -i 's/enabled: false/enabled: true/' config/test.yaml
          # Update passwords.yaml with CI password (postgres for database, no redis password)
          cat > config/passwords.yaml << EOF
          test:
            database: 'postgres'
          EOF

      - name: Run server tests
        working-directory: serverpod_admin_server
        run: dart test --reporter=failures-only

  dashboard_unit_tests:
    name: Dashboard unit tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.32.0', '3.38.4']
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Install dependencies
        working-directory: serverpod_admin_dashboard
        run: flutter pub get

      - name: Run dashboard tests
        working-directory: serverpod_admin_dashboard
        run: flutter test --reporter=failures-only

